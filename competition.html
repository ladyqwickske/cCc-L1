<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>cCc Portal - Competition Leaderboard</title>
	<link rel="icon" href="favicon.png" type="image/png">
	<script src="config.js"></script>
	<script src="portal-shim.js"></script>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
			background: linear-gradient(135deg, #232526 0%, #414345 100%);
			color: #f3f3f3;
			text-align: center;
			padding: 32px 16px 60px 16px;
			min-height: 100vh;
			background-attachment: fixed;
		}

		body { top: 0 !important; }
		.goog-te-banner-frame.skiptranslate { display: none !important; }
		iframe.goog-te-banner-frame { display: none !important; }

		.tab-nav {
			background: rgba(30, 34, 40, 0.95);
			border-bottom: 1px solid #444;
			box-shadow: 0 2px 8px rgba(0,0,0,0.25);
			position: sticky;
			top: 0;
			z-index: 1000;
		}
		.tab-nav-container { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; padding: 0 16px; overflow: visible; flex-wrap: wrap; }
		.nav-brand { font-size: 20px; font-weight: 700; color: #ffb300; padding: 16px 0; margin-right: 32px; white-space: nowrap; display: flex; align-items: center; gap: 8px; text-shadow: 0 2px 8px #000a; }
		.nav-brand img { height: 32px; width: auto; }
		.tab-buttons {
			display: flex;
			gap: 4px;
			flex: 1;
			overflow-x: auto;
			overflow-y: hidden;
			align-items: center;
			height: 100px;
		}
		.tab-btn {
			padding: 12px 16px;
			background: none;
			border: none;
			color: #e0e0e0;
			font-size: 28px;
			font-weight: 500;
			border-bottom: 3px solid transparent;
			transition: all 0.2s;
			white-space: nowrap;
			text-decoration: none;
			display: block;
			cursor: pointer;
			position: relative;
		}
		.tab-btn:hover { color: #ffb300; background: #232526; }
		.tab-btn.active { color: #ffb300; border-bottom-color: #ffb300; }
		.tab-btn[title]:hover::after {
			content: attr(title);
			position: absolute;
			top: -42px;
			left: 50%;
			transform: translateX(-50%);
			background: #232526;
			color: #ffb300;
			padding: 6px 12px;
			border-radius: 4px;
			font-size: 12px;
			white-space: nowrap;
			z-index: 1001;
			border: 1px solid #444;
			box-shadow: 0 2px 8px rgba(0,0,0,0.3);
		}
		.tab-btn .tab-icon {
			display: block;
			margin: 0 auto;
			height: 40px;
			width: auto;
			filter: drop-shadow(0 2px 8px #000a);
		}

		.hamburger {
			display: none;
			flex-direction: column;
			gap: 4px;
			background: none;
			border: none;
			cursor: pointer;
			padding: 8px;
		}
		.hamburger span {
			display: block;
			width: 24px;
			height: 3px;
			background: #ffb300;
			border-radius: 2px;
			transition: all 0.2s;
		}

		.tab-label.mobile-only { display: none; }
		.tab-icon.desktop-only { display: block; margin: 0 auto; height: 40px; width: auto; }

		.page-container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
		.header {
			margin-bottom: 20px;
			padding-bottom: 20px;
			border-bottom: 2px solid #444;
		}
		.header h1 {
			font-size: 32px;
			color: #ffb300;
			margin-bottom: 8px;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 12px;
		}
		.header p { color: #ccc; font-size: 14px; }

		.actions {
			display: flex;
			justify-content: center;
			margin-bottom: 16px;
			gap: 12px;
			flex-wrap: wrap;
		}
		.btn {
			padding: 10px 16px;
			border-radius: 6px;
			border: 1px solid #444;
			background: #232526;
			color: #ffb300;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
		}
		.btn:hover { background: #33343a; border-color: #ffb300; }

		.summary-cards {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 12px;
			margin-bottom: 16px;
		}
		.card {
			background: #1a1b1c;
			border: 1px solid #444;
			border-radius: 8px;
			padding: 16px;
		}
		.card-value { font-size: 24px; color: #ffb300; font-weight: 700; margin-bottom: 4px; }
		.card-label { font-size: 12px; color: #bbb; text-transform: uppercase; letter-spacing: .5px; }

		.table-wrap {
			background: #1a1b1c;
			border: 1px solid #444;
			border-radius: 8px;
			overflow: auto;
		}
		table { width: 100%; border-collapse: collapse; }
		thead { background: #232526; border-bottom: 2px solid #444; }
		th {
			padding: 14px 12px;
			color: #ffb300;
			text-transform: uppercase;
			letter-spacing: 1px;
			font-size: 12px;
			border-right: 1px solid #333;
		}
		th:last-child { border-right: none; }
		td {
			padding: 12px;
			border-bottom: 1px solid #333;
			border-right: 1px solid #333;
			font-size: 13px;
			color: #e0e0e0;
		}
		td:last-child { border-right: none; }
		tbody tr:hover { background: #232526; }
		.rank { color: #ffb300; font-weight: 700; }
		.player { text-align: left; font-weight: 600; }
		.points { color: #8bc34a; font-weight: 700; }
		.empty { padding: 22px; color: #bbb; }

		@media (max-width: 800px) {
			.tab-nav {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				width: 100%;
				z-index: 9999;
			}
			.tab-nav-container {
				flex-wrap: wrap;
				padding: 8px;
			}
			.nav-brand {
				flex: 1;
				margin-right: 8px;
				font-size: 16px;
				padding: 8px 0;
			}
			.nav-brand img {
				height: 24px;
				width: 24px;
			}
			.hamburger {
				display: flex;
				order: 2;
			}
			.tab-buttons {
				flex-direction: column;
				align-items: stretch;
				max-height: 60vh;
				overflow-y: auto;
				background: #232526;
				position: absolute;
				top: 60px;
				left: 0;
				right: 0;
				width: 100%;
				z-index: 10000;
				border-bottom-left-radius: 12px;
				border-bottom-right-radius: 12px;
				box-shadow: 0 8px 24px rgba(0,0,0,0.25);
				display: none;
				order: 10;
				height: auto;
			}
			.tab-buttons.open {
				display: flex;
			}
			.tab-btn {
				font-size: 18px;
				padding: 18px 24px;
				border-bottom: 1px solid #444;
				display: flex;
				align-items: center;
				justify-content: flex-start;
				background: none;
				height: auto;
			}
			.tab-btn:last-child { border-bottom: none; }
			.tab-label.mobile-only { display: inline; }
			.tab-icon.desktop-only { display: none; }
			#readOnlyBadge,
			#signedInUserBadge,
			#logoutBtn,
			#signInManageBtn {
				order: 3;
				margin: 4px 0 4px auto !important;
				font-size: 11px !important;
				padding: 6px 8px !important;
			}
			body {
				padding-top: 100px;
			}
			.header h1 { font-size: 24px; }
		}

		@media (min-width: 801px) {
			.tab-label.mobile-only { display: none; }
			.tab-icon.desktop-only { display: block; }
			.tab-buttons {
				flex-direction: row;
				align-items: center;
				position: static;
				max-height: none;
				overflow-y: visible;
				background: none;
				box-shadow: none;
				border-radius: 0;
				display: flex !important;
			}
			.tab-btn {
				font-size: 28px;
				padding: 12px 16px;
				border-bottom: 3px solid transparent;
				display: block;
				justify-content: center;
			}
			.hamburger { display: none; }
		}
	</style>
</head>
<body>
	<!-- Google Translate Widget -->
	<div id="google_translate_element" style="position:fixed;bottom:8px;right:8px;z-index:7000;"></div>
	<button id="translateToggleBtn" type="button" aria-label="Toggle translation" style="position:fixed;bottom:8px;right:8px;z-index:7001;display:none;align-items:center;justify-content:center;width:38px;height:38px;border:1px solid #444;border-radius:8px;background:#232526;color:#ffb300;font-size:18px;cursor:pointer;">üåê</button>
	<style>
		@media (max-width: 800px) {
			#google_translate_element {
				max-width: 0;
				overflow: hidden;
				opacity: 0;
				pointer-events: none;
				transition: max-width 0.2s ease, opacity 0.2s ease;
			}
			body.translate-open #google_translate_element {
				max-width: 260px;
				opacity: 1;
				pointer-events: auto;
			}
			#translateToggleBtn { display: inline-flex !important; }
		}
		@media (min-width: 801px) {
			#translateToggleBtn { display: none !important; }
		}
	</style>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const translateToggleBtn = document.getElementById('translateToggleBtn');
			const translateWidget = document.getElementById('google_translate_element');
			if (!translateToggleBtn || !translateWidget) return;
			translateToggleBtn.addEventListener('click', function (e) {
				e.stopPropagation();
				document.body.classList.toggle('translate-open');
			});
			document.addEventListener('click', function (e) {
				if (!document.body.classList.contains('translate-open')) return;
				if (translateWidget.contains(e.target) || translateToggleBtn.contains(e.target)) return;
				document.body.classList.remove('translate-open');
			});
		});
	</script>
	<script type="text/javascript">
		function googleTranslateElementInit() {
			new google.translate.TranslateElement({ pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE }, 'google_translate_element');
		}
	</script>
	<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<script>
		const BACKEND_VERIFY_URL = window.GAS_WEB_APP_URL;
		const AUTH_KEY = 'ccc_portal_google_auth';
		const AUTH_EMAIL_KEY = 'ccc_portal_google_email';

		function setReadOnlyMode(enabled) {
			if (enabled) {
				document.documentElement.classList.add('read-only-mode');
				if (document.body) document.body.classList.add('read-only-mode');
			} else {
				document.documentElement.classList.remove('read-only-mode');
				if (document.body) document.body.classList.remove('read-only-mode');
			}
		}

		function updateSignedInBadge(email) {
			const badge = document.getElementById('signedInUserBadge');
			const logoutBtn = document.getElementById('logoutBtn');
			const signInBtn = document.getElementById('signInManageBtn');
			if (!badge) return;
			if (email) {
				badge.innerHTML = email;
				badge.style.display = 'inline-block';
				if (logoutBtn) logoutBtn.style.display = 'inline-block';
				if (signInBtn) signInBtn.style.display = 'none';
			} else {
				badge.textContent = '';
				badge.style.display = 'none';
				if (logoutBtn) logoutBtn.style.display = 'none';
				if (signInBtn) signInBtn.style.display = 'inline-block';
			}
		}

		function handleLogout() {
			try { localStorage.removeItem(AUTH_KEY); } catch (e) {}
			try { localStorage.removeItem(AUTH_EMAIL_KEY); } catch (e) {}
			setReadOnlyMode(true);
			updateSignedInBadge(null);
			setTimeout(() => { window.location.reload(); }, 200);
		}

		function showGoogleLogin() {
			const loginDiv = document.createElement('div');
			loginDiv.id = 'login-overlay';
			loginDiv.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
			loginDiv.innerHTML = `
				<div style="background:#232526;padding:32px 24px;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.5);display:flex;flex-direction:column;align-items:center;gap:16px;min-width:300px;border:1px solid #444;">
					<h2 style="margin-bottom:8px;color:#ffb300;">Sign in to Manage</h2>
					<p style="font-size:14px;color:#e0e0e0;text-align:center;margin:0 0 8px 0;">Use your Google account to access management features</p>
					<div id="g_id_signin"></div>
					<div style="width:100%;height:1px;background:#444;margin:8px 0;"></div>
					<button id="guest-btn" style="width:100%;margin-top:8px;padding:12px 20px;border:1px solid #444;background:#232526;color:#ffb300;font-size:15px;font-weight:600;border-radius:6px;cursor:pointer;transition:all 0.2s;">Continue as Guest (Read-Only)</button>
					<div id="login-error" style="color:#ff5252;font-size:13px;display:none;"></div>
				</div>
			`;
			document.body.appendChild(loginDiv);

			setTimeout(() => {
				const guestBtn = document.getElementById('guest-btn');
				if (guestBtn) {
					guestBtn.onclick = function () {
						document.getElementById('login-overlay').remove();
						setReadOnlyMode(true);
						try { localStorage.removeItem(AUTH_KEY); } catch (e) {}
						try { localStorage.removeItem(AUTH_EMAIL_KEY); } catch (e) {}
						updateSignedInBadge(null);
					};
				}

				if (window.google && google.accounts && google.accounts.id) {
					try {
						google.accounts.id.initialize({
							client_id: '47674606892-0m90hd0cd01kijo69ssuqtn1j3igp32i.apps.googleusercontent.com',
							callback: onGoogleSignIn,
							auto_select: false,
							ux_mode: 'popup'
						});
						google.accounts.id.renderButton(
							document.getElementById('g_id_signin'),
							{ type: 'standard', size: 'large', theme: 'outline', text: 'signin', shape: 'rectangular', logo_alignment: 'left' }
						);
					} catch (e) {
						console.error('Error rendering Google Sign-In button:', e);
					}
				}
			}, 100);
		}

		window.onGoogleSignIn = async function (response) {
			const idToken = response.credential;
			try {
				const cfWorkerUrl = window.CLOUDFLARE_WORKER_URL || window.GAS_WEB_APP_URL;
				let tokenRes = await fetch(cfWorkerUrl, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ idToken })
				});
				let tokenData = await tokenRes.json();

				if (!tokenData.success || !tokenData.token_verified) {
					throw new Error(tokenData.error || 'Token verification failed');
				}

				const email = tokenData.email;
				const res = await fetch(BACKEND_VERIFY_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ email })
				});
				const data = await res.json();

				if (data.success && data.allowed) {
					localStorage.setItem(AUTH_KEY, '1');
					localStorage.setItem(AUTH_EMAIL_KEY, email);
					updateSignedInBadge(email);
					document.getElementById('login-overlay').remove();
					setReadOnlyMode(false);
					setTimeout(() => { window.location.reload(); }, 200);
				} else {
					setReadOnlyMode(true);
					updateSignedInBadge(null);
					document.getElementById('login-error').textContent = data.error || 'Access denied: not an authorized user.';
					document.getElementById('login-error').style.display = 'block';
				}
			} catch (err) {
				setReadOnlyMode(true);
				updateSignedInBadge(null);
				document.getElementById('login-error').textContent = 'Login failed: ' + err.message;
				document.getElementById('login-error').style.display = 'block';
			}
		};

		let isAuthed = false;
		try { isAuthed = localStorage.getItem(AUTH_KEY) === '1'; } catch (e) {}
		let authedEmail = null;
		try { authedEmail = localStorage.getItem(AUTH_EMAIL_KEY); } catch (e) {}

		setReadOnlyMode(true);
		window.addEventListener('DOMContentLoaded', function () {
			updateSignedInBadge(null);
			let nav = document.querySelector('.tab-nav-container');
			if (nav && !document.getElementById('signInManageBtn')) {
				const btn = document.createElement('button');
				btn.id = 'signInManageBtn';
				btn.textContent = 'üîë Sign in to Manage';
				btn.style = 'margin-left:16px;padding:8px 18px;background:#1a73e8;color:#fff;border:none;border-radius:5px;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.2s;';
				btn.onclick = showGoogleLogin;
				nav.appendChild(btn);
			}

			const bankTab = document.getElementById('bankTabBtn');
			if (isAuthed && authedEmail) {
				setReadOnlyMode(false);
				updateSignedInBadge(authedEmail);
				if (bankTab) bankTab.style.display = 'flex';
			} else {
				if (bankTab) bankTab.style.display = 'none';
			}
		});
	</script>

	<nav class="tab-nav">
		<div class="tab-nav-container">
			<div class="nav-brand" id="navBrand"><img src="favicon.png" alt=""> cCc Champions</div>
			<button class="hamburger" id="navHamburger" aria-label="Toggle navigation">
				<span></span>
				<span></span>
				<span></span>
			</button>
			<div class="tab-buttons" id="navTabs">
				<a href="dashboard.html" class="tab-btn" title="Dashboard"><img src="chests.png" alt="Dashboard" class="tab-icon desktop-only"><span class="tab-label mobile-only">Dashboard</span></a>
				<a href="events.html" class="tab-btn" title="Events"><img src="events.png" alt="Events" class="tab-icon desktop-only"><span class="tab-label mobile-only">Events</span></a>
				<a href="members.html" class="tab-btn" title="Members"><img src="members.png" alt="Members" class="tab-icon desktop-only"><span class="tab-label mobile-only">Members</span></a>
				<a href="troops.html" class="tab-btn" title="Troops"><img src="troops.png" alt="Troops" class="tab-icon desktop-only"><span class="tab-label mobile-only">Troops</span></a>
				<a href="progress.html" class="tab-btn" title="Progress"><img src="progress.png" alt="Progress" class="tab-icon desktop-only"><span class="tab-label mobile-only">Progress</span></a>
				<a href="compensation.html" class="tab-btn" title="Compensation"><img src="compensation.png" alt="Compensation" class="tab-icon desktop-only"><span class="tab-label mobile-only">Compensation</span></a>
				<a href="competition.html" class="tab-btn active" title="Competition"><img src="competition.png" alt="Competition" class="tab-icon desktop-only"><span class="tab-label mobile-only">Competition</span></a>
				<a href="points.html" class="tab-btn" title="Points Reference"><img src="chest_points.png" alt="Points" class="tab-icon desktop-only"><span class="tab-label mobile-only">Points Reference</span></a>
				<a href="bank.html" class="tab-btn" id="bankTabBtn" title="Bank" style="display:none;"><img src="bank.png" alt="Bank" class="tab-icon desktop-only"><span class="tab-label mobile-only">Bank</span></a>
			</div>
			<div id="readOnlyBadge" style="display: none; padding: 8px 12px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404;">üîí Read-Only Mode</div>
			<div id="signedInUserBadge" style="display: none; margin-left: auto; padding: 8px 12px; background: #1a1b1c; border-radius: 4px; font-size: 12px; color: #ffb300; border: 1px solid #444;"></div>
			<button id="logoutBtn" onclick="handleLogout()" style="display: none; margin-left: 8px; padding: 8px 10px; background: #c62828; color: #fff; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Log out</button>
		</div>
	</nav>

	<div class="page-container">
		<div class="header">
			<h1><img src="competition.png" alt="Competition" style="height: 64px;"> Competition Leaderboard</h1>
			<p>Ranking of qualified members based on CompetitionData and CompetitionChests points.</p>
		</div>

		<div class="actions">
			<button class="btn" onclick="loadCompetitionLeaderboard()">Refresh Leaderboard</button>
		</div>

		<div class="summary-cards">
			<div class="card"><div id="leaderName" class="card-value">-</div><div class="card-label">Current Leader</div></div>
			<div class="card"><div id="leaderPoints" class="card-value">-</div><div class="card-label">Leader Points</div></div>
			<div class="card"><div id="qualifiedCount" class="card-value">-</div><div class="card-label">Qualified Members</div></div>
			<div class="card"><div id="updatedAt" class="card-value" style="font-size:14px;">-</div><div class="card-label">Last Calc (UTC)</div></div>
		</div>

		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Rank</th>
						<th>Member</th>
						<th>Total Points</th>
						<th>Valid Chests</th>
						<th>Last Entry</th>
					</tr>
				</thead>
				<tbody id="leaderboardBody">
					<tr><td colspan="5" class="empty">Loading competition leaderboard...</td></tr>
				</tbody>
			</table>
		</div>
	</div>

	<script>
		function escapeHtml(text) {
			return String(text || '')
				.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;')
				.replace(/\"/g, '&quot;')
				.replace(/'/g, '&#039;');
		}

		function formatDate(value) {
			if (!value) return '-';
			if (/^\d{4}-\d{2}-\d{2}$/.test(String(value))) return String(value);
			const date = new Date(value);
			if (isNaN(date.getTime())) return '-';
			return date.toISOString().substring(0, 10);
		}

		async function loadCompetitionLeaderboard() {
			const tbody = document.getElementById('leaderboardBody');
			tbody.innerHTML = '<tr><td colspan="5" class="empty">Loading competition leaderboard...</td></tr>';
			const apiUrl = window.CLOUDFLARE_WORKER_URL || window.GAS_WEB_APP_URL;

			try {
				const response = await fetch(apiUrl, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'getCompetitionLeaderboard' })
				});

				if (!response.ok) {
					throw new Error('Network error while loading leaderboard');
				}

				const data = await response.json();
				const leaderboard = data && data.success ? (data.leaderboard || []) : [];
				document.getElementById('updatedAt').textContent = (data && data.lastCalculatedUtc) ? data.lastCalculatedUtc : 'Never';

				if (!leaderboard.length) {
					tbody.innerHTML = '<tr><td colspan="5" class="empty">No leaderboard data available yet.</td></tr>';
					document.getElementById('leaderName').textContent = '-';
					document.getElementById('leaderPoints').textContent = '-';
					document.getElementById('qualifiedCount').textContent = '0';
					return;
				}

				tbody.innerHTML = leaderboard.map((entry, index) => `
					<tr>
						<td class="rank">${index + 1}</td>
						<td class="player">${escapeHtml(entry.player)}</td>
						<td class="points">${Number(entry.totalPoints || 0).toLocaleString()}</td>
						<td>${Number(entry.totalValidChests || 0).toLocaleString()}</td>
						<td>${escapeHtml(formatDate(entry.lastEntry))}</td>
					</tr>
				`).join('');

				const leader = leaderboard[0];
				document.getElementById('leaderName').textContent = leader.player || '-';
				document.getElementById('leaderPoints').textContent = Number(leader.totalPoints || 0).toLocaleString();
				document.getElementById('qualifiedCount').textContent = leaderboard.length.toString();
			} catch (error) {
				console.error('Failed to load competition leaderboard:', error);
				tbody.innerHTML = `<tr><td colspan="5" class="empty">Failed to load data: ${escapeHtml(error.message)}</td></tr>`;
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			loadCompetitionLeaderboard();
		});
	</script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const hamburger = document.getElementById('navHamburger');
			const navTabs = document.getElementById('navTabs');
			if (hamburger && navTabs) {
				hamburger.addEventListener('click', function() {
					navTabs.classList.toggle('open');
				});
				navTabs.querySelectorAll('.tab-btn').forEach(btn => {
					btn.addEventListener('click', () => navTabs.classList.remove('open'));
				});
			}
			document.addEventListener('click', function(e) {
				if (!navTabs || !hamburger) return;
				if (!navTabs.classList.contains('open')) return;
				if (navTabs.contains(e.target) || hamburger.contains(e.target)) return;
				navTabs.classList.remove('open');
			});
		});
	</script>
</body>
</html>
